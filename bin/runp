#! /usr/bin/env bash

set -e

yml="$1"
shift
[[ ! "$yml" =~ ^.*.yml$ ]] && echo "usage: $0 start|stop <service.yml>" && exit 1
name=$(basename "$yml" .yml)

podman stop ${name} 2>/dev/null || true
pushd $(dirname $yml) > /dev/null
[ -f ./env ] && source ./env
trap "podman stop ${name} 2>/dev/null" SIGINT EXIT

parse_field() {
  _field=$1
  _param=$2
  eval echo \"$(yq-go read $yml "$_field" | xargs -I {} echo "$_param{}")\"
}

fghack podman run "$@" --rm --replace --ulimit=host --name=${name} \
  $(parse_field "pod" "--pod=") \
  $(parse_field "hostname" "--hostname=") \
  $(parse_field "ports.*" "-p=") \
  $(parse_field "volumes.*" "-v=") \
  $(parse_field "devices.*" "--device=") \
  $(parse_field "environment.*" "-e=") \
  $(parse_field "image")
